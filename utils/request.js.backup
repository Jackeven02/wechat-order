// utils/request.js
const BASE_URL = 'https://your-api-domain.com/api'; // 替换为你的API域名
const MOCK_DATA = require('../mock/mock-data.js'); // 引入模拟数据

class Request {
  constructor() {
    this.baseURL = BASE_URL;
    this.timeout = 10000;
    this.useMock = true; // 开发环境下使用模拟数据
  }

  // 核心请求方法
  request(options) {
    // 开发环境下使用模拟数据
    if (this.useMock) {
      return this.mockRequest(options);
    }

    return new Promise((resolve, reject) => {
      const {
        url,
        method = 'GET',
        data = {},
        header = {},
        loading = true
      } = options;

      // 显示加载提示
      if (loading) {
        wx.showLoading({
          title: '加载中...',
          mask: true
        });
      }

      // 获取token
      const token = wx.getStorageSync('token');

      wx.request({
        url: this.baseURL + url,
        method: method,
        data: data,
        header: {
          'Content-Type': 'application/json',
          'Authorization': token ? `Bearer ${token}` : '',
          ...header
        },
        timeout: this.timeout,
        success: (res) => {
          if (loading) {
            wx.hideLoading();
          }

          if (res.statusCode === 200) {
            if (res.data.code === 0) {
              resolve(res.data);
            } else {
              // 业务错误处理
              wx.showToast({
                title: res.data.message || '请求失败',
                icon: 'none'
              });
              reject(res.data);
            }
          } else if (res.statusCode === 401) {
            // 未授权，清除登录状态并跳转登录
            wx.removeStorageSync('userInfo');
            wx.removeStorageSync('token');
            wx.removeStorageSync('memberId');
            
            getApp().globalData.userInfo = null;
            getApp().globalData.isLogin = false;
            getApp().globalData.memberId = null;
            
            wx.navigateTo({
              url: '/pages/login/login'
            });
            reject(res);
          } else {
            wx.showToast({
              title: `请求失败(${res.statusCode})`,
              icon: 'none'
            });
            reject(res);
          }
        },
        fail: (err) => {
          if (loading) {
            wx.hideLoading();
          }
          
          wx.showToast({
            title: '网络请求失败',
            icon: 'none'
          });
          reject(err);
        }
      });
    });
  }

  get(url, data = {}, options = {}) {
    return this.request({
      ...options,
      method: 'GET',
      url,
      data
    });
  }

  post(url, data = {}, options = {}) {
    return this.request({
      ...options,
      method: 'POST',
      url,
      data
    });
  }

  put(url, data = {}, options = {}) {
    return this.request({
      ...options,
      method: 'PUT',
      url,
      data
    });
  }

  delete(url, data = {}, options = {}) {
    return this.request({
      ...options,
      method: 'DELETE',
      url,
      data
    });
  }
}

// 创建实例
const request = new Request();

module.exports = request;